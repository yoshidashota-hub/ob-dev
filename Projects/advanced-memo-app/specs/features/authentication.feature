# language: ja
機能: ユーザー認証
  ユーザーとして
  メモアプリを安全に利用したい
  なぜなら、個人情報とメモを保護したいから

  背景:
    前提 データベースが初期化されている

  シナリオ: 有効なデータで新規ユーザー登録に成功する
    前提 ユーザー "test@example.com" が未登録である
    もし 以下の情報で登録を試みる:
      | email            | password     | name      |
      | test@example.com | Password123! | Test User |
    ならば 登録に成功する
    かつ ユーザーIDが返される
    かつ パスワードがハッシュ化されて保存される
    かつ JWTトークンが発行される

  シナリオ: 無効なメールアドレスで登録失敗
    もし 以下の情報で登録を試みる:
      | email        | password     | name      |
      | invalid-mail | Password123! | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "有効なメールアドレスを入力してください" が表示される

  シナリオ: 短すぎるパスワードで登録失敗
    もし 以下の情報で登録を試みる:
      | email            | password | name      |
      | test@example.com | Pass1!   | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "パスワードは8文字以上である必要があります" が表示される

  シナリオ: 大文字を含まないパスワードで登録失敗
    もし 以下の情報で登録を試みる:
      | email            | password     | name      |
      | test@example.com | password123! | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "パスワードには大文字を含む必要があります" が表示される

  シナリオ: 数字を含まないパスワードで登録失敗
    もし 以下の情報で登録を試みる:
      | email            | password    | name      |
      | test@example.com | Password!   | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "パスワードには数字を含む必要があります" が表示される

  シナリオ: 特殊文字を含まないパスワードで登録失敗
    もし 以下の情報で登録を試みる:
      | email            | password    | name      |
      | test@example.com | Password123 | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "パスワードには特殊文字を含む必要があります" が表示される

  シナリオ: 空の名前で登録失敗
    もし 以下の情報で登録を試みる:
      | email            | password     | name |
      | test@example.com | Password123! |      |
    ならば 登録に失敗する
    かつ エラーメッセージ "名前を入力してください" が表示される

  シナリオ: 既に登録済みのメールアドレスで登録失敗
    前提 ユーザー "existing@example.com" が既に登録されている
    もし 以下の情報で登録を試みる:
      | email                | password     | name      |
      | existing@example.com | Password123! | Test User |
    ならば 登録に失敗する
    かつ エラーメッセージ "このメールアドレスは既に登録されています" が表示される

  シナリオ: 正しい認証情報でログインに成功する
    前提 以下のユーザーが登録されている:
      | email            | password     | name      |
      | user@example.com | Password123! | Test User |
    もし 以下の認証情報でログインを試みる:
      | email            | password     |
      | user@example.com | Password123! |
    ならば ログインに成功する
    かつ JWTアクセストークンが発行される
    かつ JWTリフレッシュトークンが発行される
    かつ トークンの有効期限が設定される

  シナリオ: 間違ったパスワードでログイン失敗
    前提 以下のユーザーが登録されている:
      | email            | password     | name      |
      | user@example.com | Password123! | Test User |
    もし 以下の認証情報でログインを試みる:
      | email            | password      |
      | user@example.com | WrongPass123! |
    ならば ログインに失敗する
    かつ エラーメッセージ "メールアドレスまたはパスワードが正しくありません" が表示される

  シナリオ: 存在しないユーザーでログイン失敗
    もし 以下の認証情報でログインを試みる:
      | email               | password     |
      | nouser@example.com  | Password123! |
    ならば ログインに失敗する
    かつ エラーメッセージ "メールアドレスまたはパスワードが正しくありません" が表示される

  シナリオ: 有効なトークンでログアウトに成功する
    前提 ユーザー "user@example.com" がログインしている
    もし ログアウトを試みる
    ならば ログアウトに成功する
    かつ トークンが無効化される

  シナリオ: 有効なリフレッシュトークンでアクセストークンを更新する
    前提 ユーザー "user@example.com" がログインしている
    かつ アクセストークンが期限切れである
    もし 有効なリフレッシュトークンでトークン更新を試みる
    ならば トークン更新に成功する
    かつ 新しいアクセストークンが発行される

  シナリオ: 無効なリフレッシュトークンでトークン更新失敗
    もし 無効なリフレッシュトークンでトークン更新を試みる
    ならば トークン更新に失敗する
    かつ エラーメッセージ "無効なトークンです" が表示される

  シナリオ: 期限切れのリフレッシュトークンでトークン更新失敗
    前提 ユーザー "user@example.com" がログインしている
    かつ リフレッシュトークンが期限切れである
    もし 期限切れのリフレッシュトークンでトークン更新を試みる
    ならば トークン更新に失敗する
    かつ エラーメッセージ "トークンの有効期限が切れています" が表示される
