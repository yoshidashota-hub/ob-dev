# サーバーレス vs サーバー構成 選択ガイド

## 概要

```
┌─────────────────────────────────────────────────────────────────┐
│                     アーキテクチャの選択肢                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  サーバーレス                                                   │
│  ├── Functions (Lambda, Cloud Functions)                       │
│  ├── Edge Functions (Vercel, Cloudflare Workers)               │
│  └── Containers (Fargate, Cloud Run)                           │
│                                                                 │
│  サーバー構成                                                   │
│  ├── VPS (EC2, Droplet, Vultr)                                 │
│  ├── Kubernetes (EKS, GKE)                                     │
│  └── PaaS (Railway, Render, Fly.io)                            │
│                                                                 │
│  ハイブリッド                                                   │
│  └── メインはサーバー + 一部サーバーレス                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 比較表

| 観点                   | サーバーレス         | サーバー構成   |
| ---------------------- | -------------------- | -------------- |
| **初期コスト**         | 低い（従量課金）     | 高い（固定費） |
| **スケール**           | 自動                 | 手動/設定必要  |
| **運用負荷**           | 低い                 | 高い           |
| **コールドスタート**   | あり（数百ms〜数秒） | なし           |
| **実行時間制限**       | あり（数秒〜15分）   | なし           |
| **ステート管理**       | 外部サービス必須     | ローカル可能   |
| **デバッグ**           | 難しい               | 容易           |
| **ベンダーロックイン** | 高い                 | 低い           |
| **予測可能性**         | 低い（スパイク時）   | 高い           |

## 選択フローチャート

```
┌─────────────────────────────────────────┐
│           どちらを選ぶべきか？           │
└─────────────────────────────────────────┘
                    │
    ┌───────────────┴───────────────┐
    │                               │
    ▼                               ▼
トラフィックは予測可能？        トラフィックは変動大？
    │                               │
    │ YES                           │ YES
    ▼                               ▼
┌─────────────┐               ┌─────────────┐
│サーバー構成 │               │サーバーレス │
└─────────────┘               └─────────────┘
    │                               │
    ├─ 常時稼働が必要               ├─ スパイク対応
    ├─ 長時間処理                   ├─ 低トラフィック時のコスト削減
    ├─ WebSocket                    ├─ イベント駆動
    └─ 複雑なステート               └─ API / Webhook
```

## ユースケース別おすすめ

### サーバーレスが向いているケース

```
✓ API バックエンド（REST / GraphQL）
  → Vercel Functions, AWS Lambda

✓ Webhook 処理
  → イベント発生時のみ実行

✓ 画像処理・ファイル変換
  → S3 トリガー + Lambda

✓ スケジュールタスク（Cron）
  → CloudWatch Events + Lambda

✓ 低〜中トラフィックの Web アプリ
  → Next.js on Vercel

✓ MVP / プロトタイプ
  → 素早くデプロイ、コスト最小
```

### サーバー構成が向いているケース

```
✓ WebSocket / リアルタイム通信
  → 常時接続が必要

✓ 長時間実行ジョブ
  → 動画エンコード、バッチ処理

✓ 高頻度アクセス（常時負荷）
  → 固定費の方が安くなる

✓ レガシーシステム統合
  → 特定のランタイム/ライブラリが必要

✓ 複雑なステート管理
  → インメモリキャッシュ、セッション

✓ 厳格なレイテンシ要件
  → コールドスタート不可
```

## 技術スタック別

### Next.js アプリケーション

```
┌─────────────────────────────────────────────────────────────┐
│                     Next.js デプロイ先                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Vercel（サーバーレス）                                     │
│  ├── 最適化済み、ゼロ設定                                  │
│  ├── Edge Functions 対応                                    │
│  ├── 自動スケール                                          │
│  └── 制限: 実行時間、リクエストサイズ                       │
│                                                             │
│  Railway / Render（サーバー）                               │
│  ├── 長時間実行可能                                        │
│  ├── WebSocket 対応                                        │
│  ├── カスタム設定自由                                      │
│  └── 常時稼働コストあり                                    │
│                                                             │
│  Docker + VPS（フルコントロール）                           │
│  ├── 完全な自由度                                          │
│  ├── コスト最適化可能                                      │
│  └── 運用負荷高い                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### API バックエンド

```typescript
// サーバーレス向き: Hono on Cloudflare Workers
import { Hono } from "hono";

const app = new Hono();

app.get("/api/users", async (c) => {
  // 軽量な処理
  const users = await db.query("SELECT * FROM users LIMIT 100");
  return c.json(users);
});

export default app;
```

```typescript
// サーバー向き: NestJS on Railway
@Controller("jobs")
export class JobsController {
  @Post("process")
  async processLongRunningJob(@Body() data: JobData) {
    // 長時間実行ジョブ
    const result = await this.jobService.process(data); // 30分かかる
    return result;
  }

  @WebSocketGateway()
  handleConnection(client: Socket) {
    // WebSocket 接続
  }
}
```

## コスト比較

### 低トラフィック（月100万リクエスト）

```
サーバーレス (Lambda)
├── リクエスト: 100万 × $0.0000002 = $0.20
├── 実行時間: 100万 × 100ms × $0.0000166667 = $1.67
└── 合計: 約 $2/月

サーバー (EC2 t3.micro)
├── インスタンス: $8.50/月
├── 使用率: 5%（ほぼアイドル）
└── 合計: $8.50/月

→ サーバーレスの勝ち
```

### 高トラフィック（月1億リクエスト）

```
サーバーレス (Lambda)
├── リクエスト: 1億 × $0.0000002 = $20
├── 実行時間: 1億 × 100ms × $0.0000166667 = $167
└── 合計: 約 $187/月

サーバー (EC2 t3.large × 2)
├── インスタンス: $60 × 2 = $120/月
├── ロードバランサー: $20/月
└── 合計: $140/月

→ サーバーの勝ち
```

### 損益分岐点

```
┌─────────────────────────────────────────┐
│           コストカーブ                  │
│                                         │
│  $                                      │
│  │      サーバー（固定費）              │
│  │    ─────────────────────             │
│  │   /                                  │
│  │  / サーバーレス（従量課金）          │
│  │ /                                    │
│  │/                                     │
│  ├──────────────────────────→ リクエスト│
│       ↑                                 │
│    損益分岐点                           │
│    (約500万〜1000万リクエスト/月)       │
└─────────────────────────────────────────┘
```

## ハイブリッド構成

### 推奨パターン

```
┌─────────────────────────────────────────────────────────────┐
│                    ハイブリッド構成例                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ユーザー                                                   │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────────┐                                   │
│  │   CDN + Edge        │  ← 静的アセット、エッジ処理      │
│  │   (Cloudflare)      │                                   │
│  └──────────┬──────────┘                                   │
│             │                                               │
│      ┌──────┴──────┐                                       │
│      ▼             ▼                                        │
│  ┌────────┐   ┌────────┐                                   │
│  │サーバー│   │Lambda  │                                   │
│  │(API)   │   │(非同期)│                                   │
│  └────┬───┘   └────┬───┘                                   │
│       │            │                                        │
│       ▼            ▼                                        │
│  ┌─────────────────────┐                                   │
│  │     Database        │                                   │
│  │  (RDS / DynamoDB)   │                                   │
│  └─────────────────────┘                                   │
│                                                             │
│  サーバー: 同期 API、WebSocket                              │
│  Lambda: 画像処理、通知、バッチ                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 実装例

```typescript
// メイン API（サーバー on Railway）
// apps/api/src/main.ts
@Module({
  imports: [
    UsersModule,
    OrdersModule,
    WebSocketModule, // リアルタイム
  ],
})
export class AppModule {}

// 非同期処理（Lambda）
// apps/workers/src/image-processor.ts
export const handler = async (event: S3Event) => {
  for (const record of event.Records) {
    const bucket = record.s3.bucket.name;
    const key = record.s3.object.key;

    // 画像リサイズ
    await processImage(bucket, key);
  }
};

// Edge 処理（Cloudflare Workers）
// apps/edge/src/index.ts
export default {
  async fetch(request: Request) {
    // A/B テスト、地理ベースルーティング
    const country = request.cf?.country;
    if (country === "JP") {
      return fetch(
        "https://api-jp.example.com" + new URL(request.url).pathname,
      );
    }
    return fetch("https://api.example.com" + new URL(request.url).pathname);
  },
};
```

## プラットフォーム比較

### サーバーレス

| プラットフォーム       | 特徴                           | 用途                 |
| ---------------------- | ------------------------------ | -------------------- |
| **Vercel**             | Next.js 最適化、Edge Functions | フロントエンド + API |
| **Cloudflare Workers** | 超低レイテンシ、グローバル     | Edge 処理、軽量 API  |
| **AWS Lambda**         | 豊富な統合、成熟               | バックエンド全般     |
| **Supabase Functions** | PostgreSQL 統合                | DB トリガー          |

### サーバー / PaaS

| プラットフォーム | 特徴                         | 用途              |
| ---------------- | ---------------------------- | ----------------- |
| **Railway**      | シンプル、GitHub 統合        | API、フルスタック |
| **Render**       | 無料枠あり、自動デプロイ     | API、静的サイト   |
| **Fly.io**       | グローバル分散、低レイテンシ | エッジサーバー    |
| **AWS ECS**      | コンテナ、スケーラブル       | エンタープライズ  |

### 選択早見表

```
┌────────────────────────────────────────────────────────────┐
│              プラットフォーム選択ガイド                    │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Next.js アプリ                                            │
│  └─→ Vercel（まず試す）→ Railway（制限に当たったら）      │
│                                                            │
│  API のみ                                                  │
│  └─→ Railway / Render（シンプル）                         │
│  └─→ Cloudflare Workers（超軽量）                         │
│                                                            │
│  バッチ / 非同期処理                                       │
│  └─→ AWS Lambda + SQS                                     │
│                                                            │
│  WebSocket / リアルタイム                                  │
│  └─→ Railway / Fly.io / 自前 VPS                          │
│                                                            │
│  マイクロサービス                                          │
│  └─→ Kubernetes（EKS / GKE）                              │
│                                                            │
│  個人プロジェクト / MVP                                    │
│  └─→ Vercel + Supabase（無料枠活用）                      │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

## 移行パターン

### サーバーレス → サーバー

```
理由:
- コールドスタートが許容できない
- 実行時間制限に当たった
- コストが予想以上に高い

手順:
1. Docker 化
2. Railway / Render にデプロイ
3. DNS 切り替え
```

### サーバー → サーバーレス

```
理由:
- トラフィックが不安定
- 運用負荷を減らしたい
- コスト削減（低トラフィック時）

手順:
1. ステートレス化（セッション → JWT、キャッシュ → Redis）
2. 長時間処理を分離（キュー + Worker）
3. Lambda / Vercel Functions に移行
```

## チェックリスト

### サーバーレスを選ぶ前に確認

```
□ 実行時間は制限内か？（Lambda: 15分、Vercel: 30秒）
□ コールドスタートは許容できるか？
□ WebSocket / 長時間接続は不要か？
□ ペイロードサイズは制限内か？
□ ローカル開発・デバッグ環境は整備できるか？
□ ベンダーロックインは許容できるか？
```

### サーバーを選ぶ前に確認

```
□ 運用リソース（人員・時間）はあるか？
□ スケーリング戦略は決まっているか？
□ 監視・アラート体制は整備できるか？
□ セキュリティパッチ適用の体制はあるか？
□ コストは予算内か？
```

## まとめ

### 迷ったら

| 状況                          | 選択          |
| ----------------------------- | ------------- |
| 個人開発 / スタートアップ     | サーバーレス  |
| 予測可能なトラフィック        | サーバー      |
| Next.js メイン                | Vercel        |
| 長時間処理あり                | Railway / VPS |
| 高トラフィック + 低レイテンシ | サーバー      |

### 現実的なアプローチ

1. **MVP はサーバーレスで素早く**
2. **制限に当たったら部分的にサーバー化**
3. **ハイブリッドで最適化**
