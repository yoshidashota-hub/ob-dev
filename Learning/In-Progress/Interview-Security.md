# セキュリティ - 技術面接対策

## 概要

Web セキュリティの基礎知識。認証・認可、脆弱性対策、セキュリティ設計など。

---

## 1. 基本的なセキュリティ対策

### 個人開発で意識すること

- [ ] **認証**: パスワードの bcrypt ハッシュ化、JWT 有効期限設定
- [ ] **Cookie**: Secure/HttpOnly/SameSite 属性
- [ ] **入力値検証**: SQL インジェクション対策、XSS 対策、CSRF トークン
- [ ] **依存ライブラリ**: `npm audit`、Dependabot 有効化
- [ ] **レート制限**: ログイン試行回数、API 呼び出し制限
- [ ] **環境変数**: 機密情報は `.env` で管理、`.gitignore` に追加
- [ ] **HTTPS 必須**
- [ ] **エラーメッセージ**: 内部情報を漏らさない

---

## 2. SQL インジェクション

### 原理

文字列結合で SQL を組み立てると、入力値が SQL 文として解釈される

```sql
-- 脆弱なコード
SELECT * FROM users WHERE id = '$input';

-- 攻撃例
$input = "1' OR '1'='1"
-- 結果: SELECT * FROM users WHERE id = '1' OR '1'='1'
```

### 対策

1. **プレースホルダ（プリペアドステートメント）**
2. ORM を使用
3. WAF（補助的）

```tsx
// 安全なコード
const user = await db.user.findUnique({
  where: { id: parseInt(input) },
});
```

---

## 3. XSS（Cross-Site Scripting）

### 種類

| 種類          | 説明                                                    |
| ------------- | ------------------------------------------------------- |
| Stored XSS    | DB 保存された悪意あるスクリプトが他ユーザーに実行される |
| Reflected XSS | URL パラメータがそのまま出力される                      |
| DOM-based XSS | クライアントサイドで動的に DOM を操作する際に発生       |

### 対策

- [ ] ユーザー入力のエスケープ
- [ ] CSP（Content-Security-Policy）
- [ ] サニタイズライブラリ使用

```tsx
// React では自動でエスケープ
<div>{userInput}</div>  // 安全

// dangerouslySetInnerHTML は要注意
<div dangerouslySetInnerHTML={{ __html: userInput }} />  // 危険
```

---

## 4. CSRF（Cross-Site Request Forgery）

### 攻撃フロー

```
1. ユーザーが正規サイトにログイン
2. 罠サイトにアクセス
3. 罠サイトから正規サイトへリクエスト送信
4. 認証済みユーザーの権限で操作が実行される
```

### 対策

- [ ] CSRF トークン検証
- [ ] SameSite Cookie 属性
- [ ] Referer チェック

```tsx
// Next.js Server Actions は自動で CSRF 対策済み
"use server";
export async function updateUser(formData: FormData) {
  // 自動でトークン検証される
}
```

---

## 5. SSRF（Server-Side Request Forgery）

### 原理

攻撃者が指定した URL にサーバーからリクエストを送らせる

### AWS での危険性

- メタデータエンドポイント（`169.254.169.254`）にアクセス
- IAM クレデンシャルが漏洩

### 対策

- [ ] IMDSv2（トークン必須）を使用
- [ ] URL のホワイトリスト
- [ ] 内部ネットワークへのアクセス制限

---

## 6. 認証・認可

### OAuth 2.0 vs OpenID Connect

| プロトコル     | 目的 | トークン           |
| -------------- | ---- | ------------------ |
| OAuth 2.0      | 認可 | アクセストークン   |
| OpenID Connect | 認証 | ID トークン（JWT） |

### セッションベース vs トークンベース

| 項目         | セッションベース   | トークンベース |
| ------------ | ------------------ | -------------- |
| 状態         | ステートフル       | ステートレス   |
| サーバー負荷 | セッション管理必要 | 軽減           |
| スケール     | 共有ストレージ必要 | しやすい       |
| 失効         | 容易               | 難しい         |

### JWT を localStorage に保存する問題点

- XSS で盗まれるリスク
- **解決策**: HttpOnly Cookie に保存

```tsx
// 安全な Cookie 設定
res.cookie("token", jwt, {
  httpOnly: true,
  secure: true,
  sameSite: "strict",
  maxAge: 3600000,
});
```

---

## 7. JWT の脆弱性と対策

### 脆弱性

| 脆弱性             | 説明                 |
| ------------------ | -------------------- |
| alg: none 攻撃     | 署名検証をバイパス   |
| 有効期限設定の甘さ | 長期間有効なトークン |
| トークン漏洩       | 失効させる手段がない |

### 対策

- [ ] alg を検証（none を許可しない）
- [ ] 短い有効期限 + リフレッシュトークン
- [ ] ブラックリスト機構

---

## 8. 多要素認証（MFA）

### 実装の考慮点

- [ ] TOTP/HOTP（Google Authenticator 等）
- [ ] リカバリーコードの安全な提供
- [ ] フィッシング耐性（WebAuthn/パスキー）
- [ ] SMS 認証のリスク（SIM スワップ攻撃）

---

## 9. パスワードリセット機能

### 設計のポイント

- [ ] トークンの有効期限設定（1 時間程度）
- [ ] 一度きりの使用（使用後は無効化）
- [ ] タイミング攻撃対策（定数時間で検証）
- [ ] ユーザー列挙防止（存在しないメールでも同じレスポンス）

```tsx
// ユーザー列挙防止
export async function resetPassword(email: string) {
  // 常に同じレスポンスを返す
  return { message: "メールを送信しました（登録済みの場合）" };
}
```

---

## 10. ゼロトラストセキュリティ

### 従来の境界型との違い

| 項目         | 境界型                   | ゼロトラスト           |
| ------------ | ------------------------ | ---------------------- |
| 信頼モデル   | ファイアウォール内は信頼 | すべてを検証           |
| アクセス制御 | ネットワークベース       | アイデンティティベース |
| 検証         | 初回のみ                 | 継続的                 |

### 原則

- [ ] 常に認証・認可
- [ ] 最小権限
- [ ] マイクロセグメンテーション
- [ ] 継続的な検証

---

## 11. データプライバシー・コンプライアンス

### GDPR で開発者が気をつけること

- [ ] 同意管理（オプトイン）
- [ ] データ削除（忘れられる権利）
- [ ] 越境転送（SCCs、Adequacy Decision）
- [ ] DPO（データ保護責任者）

### PII のマスキング

- [ ] 本番データの開発利用時はマスキング
- [ ] ログへの混入防止
- [ ] 保存時暗号化

---

## 学習チェックリスト

### 基本

- [ ] SQL インジェクションの原理と対策を説明できる
- [ ] XSS の種類と対策を説明できる
- [ ] CSRF の攻撃フローと対策を説明できる

### 認証・認可

- [ ] OAuth と OpenID Connect の違いを説明できる
- [ ] JWT の脆弱性と対策を説明できる
- [ ] セッションとトークンの比較ができる

### 応用

- [ ] SSRF の危険性を説明できる
- [ ] ゼロトラストの概念を説明できる
- [ ] パスワードリセットの安全な設計ができる

---

## 関連ノート

- [[Interview-Backend-API]]
- [[Interview-Network]]
- [[Interview-Architecture]]
